<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fayda ID – Advanced PDF Extractor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; background: #f4f6f8; }
        pre { background: #fff; padding: 15px; border-radius: 6px; }
    </style>
</head>
<body>

<h2>Ethiopian Digital ID – Advanced Extractor</h2>
<input type="file" id="pdfFile" accept="application/pdf">
<button onclick="extract()">Extract</button>

<pre id="out">{}</pre>

<script>
async function extract() {
    const file = document.getElementById("pdfFile").files[0];
    if (!file) return alert("Upload PDF");

    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

    let rows = [];

    for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();

        content.items.forEach(i => {
            rows.push({
                text: i.str.trim(),
                x: i.transform[4],
                y: i.transform[5],
                size: i.height
            });
        });
    }

    // --- GROUP BY ROW (Y AXIS) ---
    const grouped = {};
    rows.forEach(r => {
        const yKey = Math.round(r.y / 5) * 5;
        grouped[yKey] = grouped[yKey] || [];
        grouped[yKey].push(r);
    });

    const lines = Object.values(grouped).map(line =>
        line.sort((a,b) => a.x - b.x)
    );

    function valueRightOf(labelRegex) {
        for (const line of lines) {
            for (let i = 0; i < line.length; i++) {
                if (labelRegex.test(line[i].text)) {
                    const values = line
                        .slice(i + 1)
                        .map(v => v.text)
                        .filter(v => v.length > 1);
                    return values.join(" ");
                }
            }
        }
        return null;
    }

    function findByRegex(regex) {
        for (const r of rows) {
            if (regex.test(r.text)) return r.text;
        }
        return null;
    }

    // ---- FINAL EXTRACTION ----
    const result = {
        Name: valueRightOf(/First,\s*Middle,\s*Surname|ሙሉ\s*ስም/),
        DateOfBirth: findByRegex(/\d{2}\/\d{2}\/\d{4}/),
        Sex: findByRegex(/\bMale|Female|ወንድ|ሴት\b/),
        Phone: findByRegex(/\b09\d{8}\b/),
        FAN: rows.map(r => r.text).join("").match(/\d{16}/)?.[0] || null,
        Region: valueRightOf(/Region|ክልል/),
        Zone: valueRightOf(/Zone|ዞን/),
        Woreda: valueRightOf(/Woreda|ወረዳ/)
    };

    document.getElementById("out").textContent =
        JSON.stringify(result, null, 4);
}
</script>

</body>
</html>
